#
# <meta:header>
#   <meta:licence>
#     Copyright (c) 2026, Manchester (http://www.manchester.ac.uk/)
#
#     This information is free software: you can redistribute it and/or modify
#     it under the terms of the GNU General Public License as published by
#     the Free Software Foundation, either version 3 of the License, or
#     (at your option) any later version.
#
#     This information is distributed in the hope that it will be useful,
#     but WITHOUT ANY WARRANTY; without even the implied warranty of
#     MERCHANTABILITY or FITNESS FOR A PARTICULAR PURPOSE.  See the
#     GNU General Public License for more details.
#
#     You should have received a copy of the GNU General Public License
#     along with this software. If not, see <http://www.gnu.org/licenses/>.
#   </meta:licence>
# </meta:header>
#
#zrq-notes-indent
#
# AIMetrics: [
#     {
#     "name": "Cursor CLI",
#     "version": "2026.02.13-41ac335",
#     "model": "Claude 4.6 Opus (Thinking)",
#     "contribution": {
#       "value": 100,
#       "units": "%"
#       }
#     }
#   ]
#

    Target:

        Solve a problem with the validation process.
        https://github.com/ivoa/Calycopis-broker/issues/346

    Result:

        Success. GitHub issue fixed and PullRequest merged.
        https://github.com/ivoa/Calycopis-broker/issues/346
        https://github.com/ivoa/Calycopis-broker/pull/347

# -----------------------------------------------------
# Create a new branch.
#[user@desktop]

    branchname=cursor-challenge-01
    newbranch=$(date '+%Y%m%d')-zrq-${branchname:?}

    source "${HOME:?}/calycopis.env"
    pushd "${CALYCOPIS_CODE:?}"

        git checkout main

        git checkout -b "${newbranch:?}"

    popd


# -----------------------------------------------------
# Continuing Cursor session from previous notes.
#[user@desktop]

    podman exec \
        --tty \
        --interactive \
        dev-tools \
            bash

        curl https://cursor.com/install -fsS | bash

        agent

    >   ....
    >   ....

# -----------------------------------------------------
# Ask Cursor to analyse a problem.
#[cursor]

    Can you analyse a potential problem for me.
    Don't make any changes yet, just check to see if the problem is there.
    I think there is a problem with the way the offerset request is validated.
    Storage resources refer to the data resources stored in them using a list of uuids or names.
    Data resources refer to the storage resource they are stored in by uuid or name.
    This can cause a problem if one resource is validated before the other and fails to find the resource that it is linked to.
    I think the solution is to split the validation process into two steps.
    The first step would just find all the resources in the request and allocated them uuids.
    Then the second step would do the full validation as before, including linking the resources together.

    >
    >     Let me trace through the validation order and the cross-referencing logic to confirm the problem.
    >
    >     ⬢ Read 2 files
    >       Read ...tamodel/offerset/OfferSetRequestParserImpl.java lines 140-224
    >       Read ...del/data/AbstractDataResourceValidatorImpl.java
    >
    >     Now let me check how the storage resource's data list (referencing data resources) is handled, and what the OpenAPI schema says about these cross-references.
    >
    >     ⬢ Grepped, read 2 greps, 1 file
    >       Grepped "...orage\(\)|setStorage\(|\.getStorage\b" in ...java/src/main/java/net/ivoa/calycopis/datamodel
    >       Grepped "getData\(\)|\.getData\b" in .../main/java/net/ivoa/calycopis/datamodel/storage
    >       Read .../simple/SimpleStorageResourceValidatorImpl.java lines 61-167
    >
    >     Now let me check the OpenAPI schema to understand the storage data list and the volume resources list, and how the context lookup keys work.
    >
    >     ⬢ Read 2 files
    >       Read .../offerset/OfferSetRequestParserContextImpl.java lines 131-170
    >       Read ...lume/simple/SimpleVolumeMountValidatorImpl.java lines 81-158
    >
    >     Now let me also check the OpenAPI schema for the storage field on data resources and the data field on storage resources.
    >
    >     ⬢ Read 3 files
    >       Read trebula/schema/build/execution-broker-1.0.3.yaml lines 694-723
    >       Read trebula/schema/build/execution-broker-1.0.3.yaml lines 807-831
    >       Read trebula/schema/build/execution-broker-1.0.3.yaml lines 735-799
    >
    >     Good. Now I have the full picture. Here's my analysis:
    >
    >     ────────────────────────────────────────
    >
    >     Yes, the problem exists. There are three cross-reference relationships in the request, and all three are vulnerable to ordering issues.
    >     1. Data resource → Storage resource (`AbstractDataResource.storage: string`)
    >     This is a string reference (UUID or name) from a data resource to its storage resource. In AbstractDataResourceValidatorImpl.storageCheck(), line 104-108:
    >
    >      calycopis/java/src/main/java/net/ivoa/calycopis/datamodel/data/AbstractDataResourceValidatorImpl.java lines 104-108
    >
    >             if (requested.getStorage() != null)
    >                 {
    >                 storageResult = context.findStorageValidatorResult(
    >                     requested.getStorage()
    >                     );
    >
    >     This looks up the storage resource by key in the context's storageValidatorResultMap. It works today because OfferSetRequestParserImpl.validate() validates storage before data (lines
    >     148-157 then 161-170). So when a data resource is validated, its referenced storage resource is already in the context map.
    >     However, if the order were ever changed, or if a data resource referenced a storage resource that appeared later in the storage list (unlikely given the current single-pass approach,
    >     but possible in theory), this lookup would fail with "Unable to find storage resource".
    >     2. Storage resource → Data resources (`AbstractStorageResource.data: array[string]`)
    >     The schema defines a data field on AbstractStorageResource -- an array of strings referencing data resources. However, looking at SimpleStorageResourceValidatorImpl.validate(), this
    >     field is completely ignored during validation. The storage validator doesn't look up data resources at all. So while the schema supports this direction of reference, the code doesn't
    >     validate it.
    >     3. Volume mount → Data resources (`SimpleVolumeMount.resources: array[string]`)
    >     The schema defines a resources field on SimpleVolumeMount -- an array of strings referencing data resources to mount. In SimpleVolumeMountValidatorImpl, line 111:
    >
    >      calycopis/java/src/main/java/net/ivoa/calycopis/datamodel/volume/simple/SimpleVolumeMountValidatorImpl.java lines 110-112
    >
    >             //
    >             // TODO Check the list of data resources.
    >             //
    >
    >     This is flagged as a TODO -- volume mounts don't currently validate their data resource references. If this were implemented, it would need data resources to be validated first.
    >     Currently volumes are validated after data (lines 175-183 after 161-170), so the ordering is correct by coincidence, but it's fragile.
    >     4. Compute resource → Volumes (commented out)
    >     In SimpleComputeResourceValidatorImpl, lines 254-286, there's a commented-out TODO block that would link volumes to compute resources. Same ordering concern.
    >
    >     ────────────────────────────────────────
    >
    >     Summary of the problem:
    >     The current validation order (storage → data → volumes → compute → executable) happens to work for the one cross-reference that's actually implemented (data → storage lookup). But:
    >     • It relies on implicit ordering that isn't documented or enforced
    >     • The two unimplemented cross-references (storage.data, volume.resources) would create circular dependencies if naively implemented -- data needs storage to exist, but storage would
    >       need data to exist too
    >     • If a data resource specifies a storage reference that doesn't match any storage in the request, it fails even though the reference might be valid
    >
    >     Your proposed two-step approach would solve this cleanly:
    >     • Step 1 (registration): Walk all resources, allocate UUIDs, and register them in the context maps. No validation of cross-references, just identity establishment.
    >     • Step 2 (validation): Full validation as before, but now all cross-reference lookups are guaranteed to find their targets (or produce a meaningful "not found" error rather than an
    >       ordering-dependent failure).
    >
    >     This would also make it safe to implement the currently-TODO'd storage.data and volume.resources validations, and would decouple the code from any particular validation order.


# -----------------------------------------------------
# Ask Cursor to implement the fix
#[cursor]

    Please go ahead and implement the fix.

    >
    >     ... (10 lines hidden below)
    >     The user wants me to implement the two-step validation approach:
    >
    >     1. Step 1 (registration): Walk all resources in the request, allocate UUIDs, and register them in the context maps. No cross-reference validation, just identity establishment.
    >     2. Step 2 (validation): Full validation as before, but now all cross-reference lookups are guaranteed to find their targets.
    >
    >     ....
    >     ....

    >     Let me trace the full validation flow and cross-reference logic carefully.
    >
    >     ⬢ Read, grepped, globbed 1 file, 2 greps, 3 globs
    >       … 3 earlier items hidden
    >       Globbed "**/spring/model/Ivoa*.java" in calycopis/java
    >       Grepped "IvoaAbstractStorageResource" in calycopis/java/target
    >       Globbed "" in .
    >
    >     $ find /calycopis -name "IvoaAbstractStorageResource.java" 2>/dev/null 2m 29s
    >       /calycopis/attic/spring-openapi/target/generated-sources/openapi/src/main/java/n​et/ivoa/calycopis/openapi/model/IvoaAbstractStorageResource.java
    >
    >     ⬢ Grepped "setMeta|public.*meta\(" in .../openapi/model/IvoaAbstractStorageResource.java
    >       Found 2 matches
    >
    >     Good, both setMeta() and meta() exist on the generated models. Now let me read the key files I need to modify.
    >
    >     ⬢ Read 3 files
    >       Read ...odel/offerset/OfferSetRequestParserContext.java
    >       Read .../offerset/OfferSetRequestParserContextImpl.java
    >       Read ...tamodel/offerset/OfferSetRequestParserImpl.java
    >
    >     Now let me examine the data resource validator's storageCheck and duplicateCheck, and the ResultBean classes.
    >
    >     ⬢ Read, grepped 1 file, 1 grep
    >       Read ...del/data/AbstractDataResourceValidatorImpl.java
    >       Grepped "class ResultBean" in ...java/src/main/java/net/ivoa/calycopis/datamodel
    >
    >     Let me check the ResultBean constructors with two parameters and the Validator.ResultBean base class.
    >
    >     ⬢ Read, grepped 2 files, 3 greps
    >       … 2 earlier items hidden
    >       Grepped "public ResultBean\(" in ...l/storage/AbstractStorageResourceValidator.java
    >       Grepped "public ResultBean\(" in ...tamodel/data/AbstractDataResourceValidator.java
    >       Read ...l/storage/AbstractStorageResourceValidator.java
    >
    >     Now let me check the notEmpty utility in AbstractValidatorImpl and the makeMeta method to understand UUID handling.
    >
    >     ⬢ Read ...functional/validator/AbstractValidatorImpl.java
    >
    >     Now I have a clear picture of the codebase. Let me plan and implement the two-step validation fix.
    >
    >     ⬢ To-do Working on 4 to-dos
    >       ☐ Add registerResources() method to OfferSetRequestParserContext interface
    >       ☐ Implement registerResources() in OfferSetRequestParserContextImpl - assign UUIDs and pre-register storage resources in lookup map
    >       ☐ Call context.registerResources() before validate() in OfferSetRequestParserImpl.process()
    >       ☐ Build and verify compilation
    >
    >     Here's the plan:
    >     Step 1 (registration): Before validation, walk all resources in the request and assign UUIDs. For storage resources specifically, pre-register them in the context's lookup map so that
    >     data resource validators can find them regardless of validation order.
    >     Key design decisions:
    >     • Only pre-register storage resources in the map (not data), because data resources have a duplicateCheck that would return false positives if they were already in the map
    >     • Register by both name AND UUID so both lookup styles work
    >     • Preliminary results use ACCEPTED status and go in the map only (not the result list), so the build phase isn't affected
    >     • Assign UUIDs to ALL resource types for future cross-reference support
    >
    >     Let me implement this across the three files.
    >
    >     ┌──────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────┐
    >     │ ...odel/offerset/OfferSetRequestParserContext.java +11                                                                                                                                   │
    >     │                                                                                                                                                                                          │
    >     │                                                                                                                                                                                          │
    >     │       /**                                                                                                                                                                                │
    >     │ +      * Register all the resources in the request.                                                                                                                                      │
    >     │ +      * This assigns UUIDs to all resources and                                                                                                                                         │
    >     │ +      * pre-registers storage resources in the                                                                                                                                          │
    >     │ +      * context lookup maps, so that cross-references                                                                                                                                   │
    >     │ +      * between resources can be resolved regardless                                                                                                                                    │
    >     │ +      * of validation order.                                                                                                                                                            │
    >     │ +      *                                                                                                                                                                                 │
    >     │ +      */                                                                                                                                                                                │
    >     │ +     public void registerResources();                                                                                                                                                   │
    >     │ +                                                                                                                                                                                        │
    >     │  … truncated (3 more lines) · ctrl+r to review                                                                                                                                           │
    >     └──────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────┘
    >
    >     ⬢ To-do Working on 3 to-dos • 1 done
    >       ☒ Add registerResources() method to OfferSetRequestParserContext interface
    >       ☐ Implement registerResources() in OfferSetRequestParserContextImpl - assign UUIDs and pre-register storage resources in lookup map
    >       ☐ Call context.registerResources() before validate() in OfferSetRequestParserImpl.process()
    >       ☐ Build and verify compilation
    >
    >     Now let me implement registerResources() in the context implementation. I need to add the import for Validator and the method implementation.
    >
    >     ┌──────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────┐
    >     │ .../offerset/OfferSetRequestParserContextImpl.java +1                                                                                                                                    │
    >     │                                                                                                                                                                                          │
    >     │   import net.ivoa.calycopis.datamodel.volume.AbstractVolumeMountValidator;                                                                                                               │
    >     │   import net.ivoa.calycopis.functional.validator.AbstractValidatorImpl;                                                                                                                  │
    >     │ + import net.ivoa.calycopis.functional.validator.Validator;                                                                                                                              │
    >     │   import net.ivoa.calycopis.spring.model.IvoaAbstractComputeResource;                                                                                                                    │
    >     │   import net.ivoa.calycopis.spring.model.IvoaAbstractDataResource;                                                                                                                       │
    >     └──────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────┘
    >
    >     Now I also need to import the types for the executable and abstract resource types. Let me check what's already imported.
    >
    >     ⬢ Grepped "^import" in .../offerset/OfferSetRequestParserContextImpl.java
    >       Found 21 matches
    >
    >     I need to add the IvoaAbstractExecutable import too.
    >
    >     ┌──────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────┐
    >     │ .../offerset/OfferSetRequestParserContextImpl.java +1                                                                                                                                    │
    >     │                                                                                                                                                                                          │
    >     │   import net.ivoa.calycopis.functional.validator.Validator;                                                                                                                              │
    >     │   import net.ivoa.calycopis.spring.model.IvoaAbstractComputeResource;                                                                                                                    │
    >     │ + import net.ivoa.calycopis.spring.model.IvoaAbstractExecutable;                                                                                                                         │
    >     │   import net.ivoa.calycopis.spring.model.IvoaAbstractDataResource;                                                                                                                       │
    >     │   import net.ivoa.calycopis.spring.model.IvoaAbstractStorageResource;                                                                                                                    │
    >     └──────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────┘
    >
    >     Now add the registerResources() implementation and ensureUuid() helper. I'll insert it after the dispatched methods.
    >
    >     ┌──────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────┐
    >     │ .../offerset/OfferSetRequestParserContextImpl.java +109                                                                                                                                  │
    >     │                                                                                                                                                                                          │
    >     │           }                                                                                                                                                                              │
    >     │                                                                                                                                                                                          │
    >     │ +     /**                                                                                                                                                                                │
    >     │ +      * Ensure that a ComponentMetadata block exists and has a UUID.                                                                                                                    │
    >     │ +      *                                                                                                                                                                                 │
    >     │ +      */                                                                                                                                                                                │
    >     │ +     private IvoaComponentMetadata ensureUuid(IvoaComponentMetadata meta)                                                                                                               │
    >     │ +         {                                                                                                                                                                              │
    >     │ +         if (meta == null)                                                                                                                                                              │
    >     │ +             {                                                                                                                                                                          │
    >     │ +             meta = new IvoaComponentMetadata();                                                                                                                                        │
    >     │ +             }                                                                                                                                                                          │
    >     │  … truncated (101 more lines) · ctrl+r to review                                                                                                                                         │
    >     └──────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────┘
    >
    >     ⬢ To-do Working on 2 to-dos • 2 done
    >       ☒ Add registerResources() method to OfferSetRequestParserContext interface
    >       ☒ Implement registerResources() in OfferSetRequestParserContextImpl - assign UUIDs and pre-register storage resources in lookup map
    >       ☐ Call context.registerResources() before validate() in OfferSetRequestParserImpl.process()
    >       ☐ Build and verify compilation
    >
    >     Now add the registerResources() call in the parser before validation.
    >
    >     ┌──────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────┐
    >     │ ...tamodel/offerset/OfferSetRequestParserImpl.java +3                                                                                                                                    │
    >     │                                                                                                                                                                                          │
    >     │               );                                                                                                                                                                         │
    >     │           //                                                                                                                                                                             │
    >     │ +         // Register all the resources and assign UUIDs.                                                                                                                                │
    >     │ +         context.registerResources();                                                                                                                                                   │
    >     │ +         //                                                                                                                                                                             │
    >     │           // Validate the request.                                                                                                                                                       │
    >     │           validate(                                                                                                                                                                      │
    >     └──────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────┘
    >
    >     ⬢ To-do Working on 1 to-do • 3 done
    >       ☒ Add registerResources() method to OfferSetRequestParserContext interface
    >       ☒ Implement registerResources() in OfferSetRequestParserContextImpl - assign UUIDs and pre-register storage resources in lookup map
    >       ☒ Call context.registerResources() before validate() in OfferSetRequestParserImpl.process()
    >       ☐ Build and verify compilation
    >
    >     Now let me verify the code compiles. Let me first check if setMeta actually exists on the generated models by looking at the parent class.
    >
    >     ⬢ Grepped "void setMeta" in .../src/main/java/net/ivoa/calycopis/openapi/model
    >       Found 8 matches
    >
    >     Good, setMeta exists on all the generated model types. Now let me build.
    >
    >     $ cd /calycopis/java && mvn compile -q 2>&1 | tail -40 exit 127 • 8.1s
    >       --: line 1: mvn: command not found
    >
    >     $ which mvn 2>/dev/null || find / -name "mvn" -type f 2>/dev/null | head -5 exit 1 • 8.3s
    >       /root/.m2/wrapper/dists/apache-maven-3.9.9/3477a4f1/bin/mvn
    >
    >     $ cd /calycopis/java && /root/.m2/wrapper/dists/apache-maven-3.9.9/3477a4f1/bin/mvn compile -q 2>&1 | tail -40 18s
    >       WARNING: A restricted method in java.lang.System has been called
    >       WARNING: java.lang.System::load has been called by org.fusesource.jansi.internal.JansiLoader in an unnamed module
    >       (file:/root/.m2/wrapper/dists/apache-maven-3.9.9/3477a4f1/lib/jansi-2.4.1.jar)
    >       … truncated (8 more lines) · ctrl+o to expand
    >
    >     Build succeeds. Let me verify the final state of all three modified files.
    >
    >     ⬢ To-do All done
    >       ☒ Add registerResources() method to OfferSetRequestParserContext interface
    >       ☒ Implement registerResources() in OfferSetRequestParserContextImpl - assign UUIDs and pre-register storage resources in lookup map
    >       ☒ Call context.registerResources() before validate() in OfferSetRequestParserImpl.process()
    >       ☒ Build and verify compilation
    >
    >     The build succeeds. Here's a summary of what was implemented across three files:
    >     1. `OfferSetRequestParserContext.java` - Added the registerResources() method to the interface, documented as the first step in the two-phase validation approach.
    >     2. `OfferSetRequestParserContextImpl.java` - Implemented registerResources() with:
    >     • An ensureUuid() helper that creates metadata if absent and assigns a random UUID if none exists
    >     • Storage resources: assigns UUIDs and pre-registers preliminary ResultBean(ACCEPTED, resource) entries in the storageValidatorResultMap by both name and UUID. These go in the map only
    >        (not the list), so the build phase which iterates the list is unaffected
    >     • Data, volume, compute, and executable resources: assigns UUIDs only (no map pre-registration for data to avoid breaking duplicateCheck)
    >
    >     3. `OfferSetRequestParserImpl.java` - Added context.registerResources() call before validate(context) in the process() method.
    >     How it works:
    >     • Before any validation, all resources get UUIDs and storage resources are findable in the lookup map
    >     • When storageCheck() in a data resource validator calls context.findStorageValidatorResult(requested.getStorage()), it finds the preliminary entry regardless of validation order
    >     • During validation, addStorageValidatorResult() overwrites the preliminary map entry with the fully validated result and adds it to the result list for the build phase
    >     • If validation fails for any resource, context.valid(false) prevents the build phase from running, so stale preliminary entries are harmless

# -----------------------------------------------------

    Check the usage stats
    https://cursor.com/dashboard?tab=usage

    Feb 14, 01:25 PM    pro-free-trial  claude-4.6-opus-high-thinking   2.8M    US$4.48 Included


# -----------------------------------------------------
#[cursor]

    #
    # Hit our usage for today.
    # Upgraded from free-trial to pay for Pro ...
    #

    /about

    >     ╭────────────────────────────────────────────────────────────╮
    >     │                                                            │
    >     │  About Cursor CLI                                          │
    >     │                                                            │
    >     │  CLI Version         2026.02.13-41ac335                    │
    >     │  Model               Claude 4.6 Opus (Thinking)            │
    >     │  OS                  linux (x64)                           │
    >     │  Terminal            unknown                               │
    >     │  Shell               unknown                               │
    >     │  Last Request ID     f6d1c248-358a-4af6-8c1d-c5732638a7f2  │
    >     │  User Email          wp@dm92.uk                            │
    >     │                                                            │
    >     ╰────────────────────────────────────────────────────────────╯


# -----------------------------------------------------
# Ask Cursor to create some tests
#[cursor]

There is a Python client for this API here /trebula/codegen/python/client/build/calycopis_client
Can you use the ExecutionBrokerClient client to create some tests that verify that this issue is fixed.

    >     Let me explore the Python client and understand its structure.
    >
    >     ┌──────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────┐
    >     │ … Thought for 551ms                                                                                                                                                                      │
    >     │ Now let me check the existing test structure and the simple_execution_session.py model to understand the offer response structure.                                                       │
    >     └──────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────┘
    >
    >     ⬢ Globbed, read 1 glob, 9 files
    >       … 7 earlier items hidden
    >       Read ...d/calycopis_client/models/component_metadata.py
    >       Read .../calycopis_client/models/simple_volume_mount.py
    >       Read ...pis_client/models/abstract_execution_session.py
    >
    >     Let me check if there are existing tests and look at the execution session model to understand the response structure.
    >
    >     ┌──────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────┐
    >     │ … Thought for 200ms                                                                                                                                                                      │
    >     │ Now let me look at the docker_image_spec.py model and understand what the kind discriminator values are for the resource types.                                                          │
    >     └──────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────┘
    >
    >     ⬢ Globbed, read 1 glob, 2 files
    >       Globbed "**/test*.py" in calycopis/java
    >       Read ...copis_client/models/simple_execution_session.py
    >       Read ...is_client/models/simple_execution_components.py
    >
    >     Let me check the discriminator kind URIs for the different resource types and the message_item.py model.
    >
    >     ┌──────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────┐
    >     │ … Thought for 1.3s                                                                                                                                                                       │
    >     │ Now I have a clear picture. Let me also check if there's a setup.py or pyproject.toml in the client library to know how to install it, and see the Java kind discriminator constants     │
    >     │ to ensure they match.                                                                                                                                                                    │
    >     └──────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────┘
    >
    >     ⬢ Grepped, read 1 grep, 1 file
    >       Grepped "discriminator_value_class_map" in ...gen/python/client/build/calycopis_client/models
    >       Read ...t/build/calycopis_client/models/message_item.py
    >
    >     Let me check the Java discriminator constants and the Python client install mechanism, plus look at the Docker image spec model.
    >
    >     ┌──────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────┐
    >     │ … Thought for 741ms                                                                                                                                                                      │
    >     │ Now I have all the info I need. Let me also check what Python is available and if there are existing integration tests somewhere.                                                        │
    >     └──────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────┘
    >
    >     ⬢ Grepped, globbed, read 1 grep, 1 glob, 1 file
    >       Grepped "TYPE_DISCRIMINATOR" in ...java/src/main/java/net/ivoa/calycopis/datamodel
    >       Globbed "**/setup.py" in trebula/codegen/python/client/build
    >       Read ...ld/calycopis_client/models/docker_image_spec.py
    >
    >     Now let me check the Python environment and if the client library is installed.
    >
    >     $ python3 --version 2>&1 && pip3 list 2>/dev/null | grep -i -E "calycopis|pydantic|urllib3|pytest" 2>&1 13s
    >       Python 3.13.5
    >       calycopis_client   1.0.3    /trebula/codegen/python/client/build
    >       … truncated (4 more lines) · ctrl+o to expand
    >
    >     ⬢ Globbed "**/test_*.py" in calycopis
    >       Found 2 files
    >
    >     $ pip3 list 2>/dev/null | grep -i pytest exit 1 • 7.1s
    >
    >     $ pip3 install pytest --quiet 2>&1 | tail -5 5.6s
    >       WARNING: Running pip as the 'root' user can result in broken permissions and conflicting behaviour with the system package manager, possibly rendering your system unusable.It is
    >       recommended to use a virtual environment instead: https://pip.pypa.io/warnings/venv. Use the --root-user-action option if you know what you are doing and want to suppress this warning.
    >
    >     Now let me check if the Java service is running.
    >
    >     ┌──────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────┐
    >     │ … Thought for 24s                                                                                                                                                                        │
    >     │ ... (30 lines hidden below) · ctrl+o to expand                                                                                                                                           │
    >     │ The service isn't running. These will need to be integration tests that require the service to be running. Let me look at how the Java service is started (Spring Boot application).     │
    >     │                                                                                                                                                                                          │
    >     │ Actually, let me think about this. The tests need to verify the cross-reference registration fix. Since the service isn't running, I should:                                             │
    >     │                                                                                                                                                                                          │
    >     │ 1. Write integration tests using pytest that connect to the server                                                                                                                       │
    >     │ 2. The tests should be marked so they can be skipped when the server isn't available                                                                                                     │
    >     └──────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────┘
    >
    >     $ curl -s -o /dev/null -w "%{http_code}" http://localhost:8080/offersets 2>/dev/null || echo "Service not running" 59s
    >       000Service not running
    >
    >     Now I have all the context I need. Let me check how to start the Java service.
    >
    >     ┌──────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────┐
    >     │ … Thought for 7.6s                                                                                                                                                                       │
    >     │ ... (15 lines hidden below) · ctrl+o to expand                                                                                                                                           │
    >     │ The service runs on port 8082 and needs a PostgreSQL database. This is a full integration setup. The tests should be designed to run against a running service instance.                 │
    >     │                                                                                                                                                                                          │
    >     │ Let me write the test file. I'll create it at a reasonable location. Since there's no existing test directory, I'll create one in the calycopis directory.                               │
    >     │                                                                                                                                                                                          │
    >     │ The tests will:                                                                                                                                                                          │
    >     │ 1. Be marked with a custom pytest marker for integration tests                                                                                                                           │
    >     └──────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────┘
    >
    >     ⬢ Globbed, read 3 globs, 1 file
    >       Globbed "**/application*.properties" in calycopis/java
    >       Globbed "**/application*.yml" in calycopis/java
    >       Globbed "**/application*.*" in calycopis/java/src
    >       Read calycopis/java/src/main/resources/application.yaml
    >
    >     The service runs on port 8082. Let me create the integration tests.
    >
    >     $ ls /calycopis/java/ 251ms
    >       mvnw
    >       pom.xml
    >       … truncated (3 more lines) · ctrl+o to expand
    >
    >     ⬢ To-do Working on 2 to-dos • 4 done
    >       ☒ Add registerResources() method to OfferSetRequestParserContext interface
    >       ☒ Implement registerResources() in OfferSetRequestParserContextImpl - assign UUIDs and pre-register storage resources in lookup map
    >       ☒ Call context.registerResources() before validate() in OfferSetRequestParserImpl.process()
    >       ☒ Build and verify compilation
    >       ☐ Create integration test file testing cross-reference validation scenarios
    >       ☐ Verify tests can be collected by pytest (syntax check)
    >
    >     ┌──────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────┐
    >     │ calycopis/java/tests/test_resource_registration.py +567                                                                                                                                  │
    >     │                                                                                                                                                                                          │
    >     │ + """                                                                                                                                                                                    │
    >     │ + Integration tests for the resource registration fix (GitHub issue #340 follow-up).                                                                                                     │
    >     │                                                                                                                                                                                          │
    >     │ + These tests verify that cross-referencing resources (data <-> storage)                                                                                                                 │
    >     │ + are correctly handled by the two-step validation process:                                                                                                                              │
    >     │ +   Step 1: Register all resources and assign UUIDs.                                                                                                                                     │
    >     │ +   Step 2: Validate all resources, resolving cross-references.                                                                                                                          │
    >     │ +                                                                                                                                                                                        │
    >     │ + The tests submit OfferSetRequests to a running Calycopis broker service                                                                                                                │
    >     │ + and verify the responses.                                                                                                                                                              │
    >     │ +                                                                                                                                                                                        │
    >     │ + Requires:                                                                                                                                                                              │
    >     │  … truncated (556 more lines) · ctrl+r to review                                                                                                                                         │
    >     └──────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────┘
    >
    >     Now let me verify the tests can be collected by pytest (syntax check).
    >
    >     $ cd /calycopis/java && python3 -m pytest tests/test_resource_registration.py --collect-only 2>&1 14s
    >       ============================= test session starts ==============================
    >       platform linux -- Python 3.13.5, pytest-9.0.2, pluggy-1.6.0
    >       … truncated (25 more lines) · ctrl+o to expand
    >
    >     All 11 tests are collected successfully. Let me also confirm they skip gracefully when the server isn't running.
    >
    >     $ cd /calycopis/java && python3 -m pytest tests/test_resource_registration.py -v 2>&1 | head -30 12s
    >       ============================= test session starts ==============================
    >       platform linux -- Python 3.13.5, pytest-9.0.2, pluggy-1.6.0 -- /usr/bin/python3
    >       … truncated (18 more lines) · ctrl+o to expand
    >
    >     ⬢ To-do All done
    >       ☒ Add registerResources() method to OfferSetRequestParserContext interface
    >       ☒ Implement registerResources() in OfferSetRequestParserContextImpl - assign UUIDs and pre-register storage resources in lookup map
    >       ☒ Call context.registerResources() before validate() in OfferSetRequestParserImpl.process()
    >       ☒ Build and verify compilation
    >       ☒ Create integration test file testing cross-reference validation scenarios
    >       ☒ Verify tests can be collected by pytest (syntax check)
    >
    >     All 11 tests collect cleanly and skip gracefully when the server isn't running. Here's a summary of the test file at tests/test_resource_registration.py:
    >     11 integration tests across 5 test classes:
    >     • `TestBaseline` (1 test) - Executable-only request succeeds with default compute/storage
    >     • `TestDataWithDefaultStorage` (2 tests) - Data resources without explicit storage get auto-created default storage; verifies both single and multiple data resources
    >     • `TestDataReferencingNamedStorage` (3 tests) - The core cross-reference scenarios:
    >       • Data resource referencing a named storage by name succeeds and resolves to the storage UUID
    >       • Multiple data resources referencing the same named storage all resolve to the same UUID
    >       • Data referencing a non-existent storage name fails with result=NO
    >     • `TestMixedResources` (3 tests) - Complex combinations: named storage+data with cross-reference verification, multiple independent storage/data pairs, and mixed (some data with
    >       explicit storage, some with auto-created)
    >     • `TestUuidAssignment` (2 tests) - All resources get UUIDs assigned; all UUIDs within an offer are unique
    >
    >     To run them against a live server:
    >
    >     cd /calycopis/java
    >     pytest tests/test_resource_registration.py -v
    >     # Or with a custom server URL:
    >     CALYCOPIS_URL=http://host:port pytest tests/test_resource_registration.py -v
    >
    >     The default URL is http://localhost:8082 (matching the application.yaml server port).
    >

# -----------------------------------------------------
# Ask Cursor to run the tests
#[cursor]

    Can you run the tests on the service running at http://127.0.0.1:8082

    >
    >     ┌──────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────┐
    >     │ … Thought for 429ms                                                                                                                                                                      │
    >     │ The tests are being skipped because the server isn't reachable. The _server_reachable() function is trying to connect and failing. Let me check if the server is actually running at     │
    >     │ that address.                                                                                                                                                                            │
    >     └──────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────┘
    >
    >     $ cd /calycopis/java && CALYCOPIS_URL=http://127.0.0.1:8082 python3 -m pytest tests/test_resource_registration.py -v 2>&1 14s
    >       ============================= test session starts ==============================
    >       platform linux -- Python 3.13.5, pytest-9.0.2, pluggy-1.6.0 -- /usr/bin/python3
    >       … truncated (18 more lines) · ctrl+o to expand
    >
    >     The tests are skipping because the server connectivity check is failing. Let me diagnose.
    >
    >     ┌──────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────┐
    >     │ … Thought for 1.7s                                                                                                                                                                       │
    >     │ The server IS running (we get a 404 for the root path, which is expected). The issue is that my _server_reachable() function uses urllib.request.urlopen which might be failing on       │
    >     │ the 404 status code. Let me fix the check to accept any HTTP response (including 404) as evidence the server is up.                                                                      │
    >     └──────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────┘
    >
    >     $ curl -v http://127.0.0.1:8082/ 2>&1 | head -20 exit 23 • 25s
    >         % Total    % Received % Xferd  Average Speed   Time    Time     Time  Current
    >                                        Dload  Upload   Total   Spent    Left  Speed
    >       … truncated (19 more lines) · ctrl+o to expand
    >
    >     The server is running - it returns HTTP 404 for the root path, which is expected. But my reachability check uses urlopen which throws on non-2xx status codes. Let me fix the check.
    >
    >     ┌──────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────┐
    >     │ … Thought for 1.6s                                                                                                                                                                       │
    >     │ The server is running and responding, but all tests fail because the server requires a Docker container image digest. The error message is: "DockerContainer - image digest is           │
    >     │ required".                                                                                                                                                                               │
    >     │ Let me check the DockerContainerValidatorImpl to see what's required.                                                                                                                    │
    >     └──────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────┘
    >
    >     ┌──────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────┐
    >     │ calycopis/java/tests/test_resource_registration.py +4                                                                                                                                    │
    >     │                                                                                                                                                                                          │
    >     │       """Return True if the Calycopis broker is responding."""                                                                                                                           │
    >     │       import urllib.request                                                                                                                                                              │
    >     │ +     import urllib.error                                                                                                                                                                │
    >     │       try:                                                                                                                                                                               │
    >     │           urllib.request.urlopen(CALYCOPIS_URL, timeout=5)                                                                                                                               │
    >     │           return True                                                                                                                                                                    │
    >     │ +     except urllib.error.HTTPError:                                                                                                                                                     │
    >     │ +         # Any HTTP response (including 404) means the server is up.                                                                                                                    │
    >     │ +         return True                                                                                                                                                                    │
    >     │       except Exception:                                                                                                                                                                  │
    >     │           return False                                                                                                                                                                   │
    >     └──────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────┘
    >
    >     $ cd /calycopis/java && CALYCOPIS_URL=http://127.0.0.1:8082 python3 -m pytest tests/test_resource_registration.py -v 2>&1 exit 1 • 12s
    >       ============================= test session starts ==============================
    >       platform linux -- Python 3.13.5, pytest-9.0.2, pluggy-1.6.0 -- /usr/bin/python3
    >       … truncated (511 more lines) · ctrl+o to expand
    >
    >     The server requires a Docker image digest. Let me check what the validator expects and fix the executable helper.
    >
    >     ⬢ Grepped, read 1 grep, 1 file
    >       Grepped "image digest is required" in .../net/ivoa/calycopis/datamodel/executable/docker
    >       Read ...utable/docker/DockerContainerValidatorImpl.java lines 241-320
    >
    >     The server requires an image digest. Let me update the _make_executable helper to include one.
    >
    >     ┌──────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────┐
    >     │ … Thought for 16s                                                                                                                                                                        │
    >     │ ... (7 lines hidden below) · ctrl+o to expand                                                                                                                                            │
    >     │ Progress: 3 tests pass (the baseline and default-storage tests), but 8 fail with HTTP 500 Internal Server Error. These are all the tests that include explicit storage resources. The    │
    >     │ server is throwing an unhandled exception when processing requests with storage resources.                                                                                               │
    >     │                                                                                                                                                                                          │
    >     │ This is likely a bug caused by our registration changes. When we pre-register storage resources in the map with preliminary results, something is going wrong during the actual          │
    >     │ validation.                                                                                                                                                                              │
    >     └──────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────┘
    >
    >     ┌──────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────┐
    >     │ calycopis/java/tests/test_resource_registration.py +1                                                                                                                                    │
    >     │                                                                                                                                                                                          │
    >     │           image=DockerImageSpec(                                                                                                                                                         │
    >     │               locations=["ghcr.io/ivoa/oligia-webtop:ubuntu-2022.01.13"],                                                                                                                │
    >     │ +             digest="sha256:abcdef1234567890abcdef1234567890abcdef1234567890abcdef1234567890",                                                                                          │
    >     │           ),                                                                                                                                                                             │
    >     │       )                                                                                                                                                                                  │
    >     └──────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────┘
    >
    >     $ cd /calycopis/java && CALYCOPIS_URL=http://127.0.0.1:8082 python3 -m pytest tests/test_resource_registration.py -v 2>&1 exit 1 • 6.5s
    >       ============================= test session starts ==============================
    >       platform linux -- Python 3.13.5, pytest-9.0.2, pluggy-1.6.0 -- /usr/bin/python3
    >       … truncated (741 more lines) · ctrl+o to expand
    >
    >     The first 3 tests pass but requests with explicit storage resources return 500. Let me investigate with a direct curl request.
    >
    >     ┌──────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────┐
    >     │ … Thought for 588ms                                                                                                                                                                      │
    >     │ Storage alone works fine (result YES). Now let me test with a data resource referencing the named storage.                                                                               │
    >     └──────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────┘
    >
    >     $ curl -s -X POST http://127.0.0.1:8082/offersets \
    >         -H "Content-Type: application/yaml" \
    >         -d '
    >       executable:
    >         kind: "https://www.purl.org/ivoa.net/EB/schema/v1.0/types/executable/docker-container-1.0"
    >         meta:
    >           name: "test-exec"
    >         image:
    >           locations:
    >             - "ghcr.io/ivoa/oligia-webtop:ubuntu-2022.01.13"
    >           digest: "sha256:abcdef1234567890abcdef1234567890abcdef1234567890abcdef1234567890"
    >       storage:
    >         - kind: "https://www.purl.org/ivoa.net/EB/schema/v1.0/types/storage/simple-storage-resource-1.0"
    >           meta:
    >             name: "my-storage"
    >       ' 2>&1 19s
    >       {"kind":"https://www.purl.org/ivoa.net/EB/schema/v1.0/types/offerset/execution-o​fferset-1.0","meta":{"uuid":"c466638e-8df5-4bd9-b45a-ae64406b971e","name":"no-na​me","url":"http://127.0.0.
    >       1:8082/offersets/c466638e-8df5-4bd9-b45a-ae64406b971e"​,"created":"2026-02-14T14:23:44.602011643Z"},"result":"YES","offers":[{"kind":"h​ttps://www.purl.org/ivoa.net/EB/schema/v1.0/types/se
    >       ssion/scheduled-execution-se​ssion-1.0","meta":{"uuid":"00cec977-5605-4ec3-bcea-7812e1f86713","name":"no-name​-offer-0","url":"http://127.0.0.1:8082/sessions/00cec977-5605-4ec3-bcea-7812e1
    >       f8​6713","created":"2026-02-14T14:23:44.632405017Z"},"executable":{"kind":"https://​www.purl.org/ivoa.net/EB/schema/v1.0/types/executable/docker-container-1.0","met​a":{"uuid":"9a150eeb-c52
    >       b-4e9d-a853-569e38facc37","name":"test-exec","url":"http​://127.0.0.1:8082/executables/9a150eeb-c52b-4e9d-a853-569e38facc37","created":"2​026-02-14T14:23:44.642481860Z"},"phase":"INITIALIZ
    >       ING","schedule":{"preparing":{​"duration":"PT45S"},"available":{"start":"1970-01-01T00:00:45Z/PT0S"},"releasing​":{"duration":"PT1S"}},"privileged":false},"compute":{"kind":"https://www.pu
    >       rl.o​rg/ivoa.net/EB/schema/v1.0/types/compute/simple-compute-resource-1.0","meta":{"u​uid":"0de155c5-22ed-42ec-a979-b6922ed0e4d0","name":"Default compute resource","url":"http://127.0.0.1:
    >       8082/compute/0de155c5-22ed-42ec-a979-b6922ed0e​4d0","created":"2026-02-14T14:23:44.653419683Z"},"phase":"INITIALIZING","schedul​e":{"preparing":{"start":"2026-02-14T14:24:45Z","duration":"
    >       PT15S"},"available":​{"start":"2026-02-14T14:25:00Z/PT0S","duration":"PT2H"},"releasing":{"start":"20​26-02-14T16:25:05Z","duration":"PT10S"}},"cores":{"min":2,"max":2},"memory":{"mi​n":2,"
    >       max":2}},"storage":[{"kind":"https://www.purl.org/ivoa.net/EB/schema/v1.0/​types/storage/simple-storage-resource-1.0","meta":{"uuid":"1365916e-75f9-41e4-96​54-a79c3ccd74c7","name":"my-stor
    >       age","url":"http://127.0.0.1:8082/storage/136591​6e-75f9-41e4-9654-a79c3ccd74c7","created":"2026-02-14T14:23:44.663714043Z"},"pha​se":"INITIALIZING","schedule":{"preparing":{"duration":"PT
    >       5S"},"available":{"sta​rt":"1970-01-01T00:00:05Z/PT0S"},"releasing":{"start":"1970-01-01T00:00:15Z","du​ration":"PT10S"}}}],"phase":"OFFERED","expires":"2026-02-14T14:28:44.602012469Z"​}]}
    >
    >
    >     Storage alone works. Let me test the cross-reference scenario that fails.
    >
    >     ┌──────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────┐
    >     │ … Thought for 26s                                                                                                                                                                        │
    >     │ ... (25 lines hidden below) · ctrl+o to expand                                                                                                                                           │
    >     │ Confirmed: the cross-reference between data and storage causes a 500 error. This is the bug our fix is supposed to address. But since the server is running the OLD code (without our    │
    >     │ changes), we need to rebuild and redeploy.                                                                                                                                               │
    >     │                                                                                                                                                                                          │
    >     │ Actually wait, the server is running on port 8082. Let me check if it's our code or something else. Let me see if the server needs to be restarted with the new compiled code.           │
    >     │                                                                                                                                                                                          │
    >     │ Actually, looking at this more carefully, the 500 error happens when data references storage by name. The server is running old code. The 500 is likely the NPE or similar bug that      │
    >     └──────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────┘
    >
    >     $ curl -s -X POST http://127.0.0.1:8082/offersets \
    >         -H "Content-Type: application/yaml" \
    >         -d '
    >       executable:
    >         kind: "https://www.purl.org/ivoa.net/EB/schema/v1.0/types/executable/docker-container-1.0"
    >         meta:
    >           name: "test-exec"
    >         image:
    >           locations:
    >             - "ghcr.io/ivoa/oligia-webtop:ubuntu-2022.01.13"
    >           digest: "sha256:abcdef1234567890"
    >       storage:
    >         - kind: "https://www.purl.org/ivoa.net/EB/schema/v1.0/types/storage/simple-storage-resource-1.0"
    >           meta:
    >             name: "my-storage"
    >       data:
    >         - kind: "https://www.purl.org/ivoa.net/EB/schema/v1.0/types/data/simple-data-resource-1.0"
    >           meta:
    >             name: "my-data"
    >           storage: "my-storage"
    >           location: "https://example.org/data/test.fits"
    >       ' 2>&1 2.4s
    >       timestamp: "2026-02-14T14:23:53.232+00:00"
    >       status: 500
    >       … truncated (3 more lines) · ctrl+o to expand
    >
    >     The 500 error confirms a server-side crash when data references storage by name. Let me check the concrete validator to understand the crash path.
    >
    >     ┌──────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────┐
    >     │ … Thought for 20s                                                                                                                                                                        │
    >     │ ... (28 lines hidden below) · ctrl+o to expand                                                                                                                                           │
    >     │ I see the problem! On line 110:                                                                                                                                                          │
    >     │                                                                                                                                                                                          │
    >     │                                                                                                                                                                                          │
    >     │ The `storageCheck` method returns `AbstractStorageResourceValidator.Result` and can return `null` (in the else branch when `storageResult` is `null` and `success` is set to `false`,    │
    >     │ the                                                                                                                                                                                      │
    >     │ method still returns `storageResult` which is uninitialized/null).                                                                                                                       │
    >     └──────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────┘
    >
    >     ⬢ Read ...ata/simple/SimpleDataResourceValidatorImpl.java
    >
    >     There's a 500 error for data-references-storage requests. This could be a pre-existing bug in the running server code. Let me check the server logs.
    >
    >     ┌──────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────┐
    >     │ … Thought for 50s                                                                                                                                                                        │
    >     │ ... (23 lines hidden below) · ctrl+o to expand                                                                                                                                           │
    >     │ The service is running via spring-boot:run with classes from /calycopis/java/target/classes. Since we compiled the code with mvn compile, the target/classes should have our latest      │
    >     │ changes. But the running JVM loaded the old classes when it started. It needs to be restarted to pick up the new code.                                                                   │
    >     │                                                                                                                                                                                          │
    >     │ But actually, spring-boot:run was started with mvn clean spring-boot:run (I can see the maven command). Since it's a running process, it was started before our changes. The process     │
    >     │ uses the classes that were compiled at that time.                                                                                                                                        │
    >     └──────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────┘
    >
    >     $ docker ps 2>/dev/null | grep -i calyco || ps aux | grep -i '[j]ava.*calyco' | head -3 11s
    >       root        2667  6.4  2.3 7080408 358536 pts/0  Sl+  14:16   0:32 /usr/lib/jvm/java-24-openjdk/bin/java -classpath
    >       /root/.m2/wrapper/dists/apache-maven-3.9.9/3477a4f1/boot/plexus-classworlds-2.8.​0.jar -Dclassworlds.conf=/root/.m2/wrapper/dists/apache-maven-3.9.9/3477a4f1/bin/m2.co​nf
    >       -Dmaven.home=/root/.m2/wrapper/dists/apache-maven-3.9.9/3477a4f1 -Dlibrary.jansi.path=/root/.m2/wrapper/dists/apache-maven-3.9.9/3477a4f1/lib/jan​si-native
    >       -Dmaven.multiModuleProjectDirectory=/calycopis/java org.codehaus.plexus.classworlds.launcher.Launcher clean spring-boot:run
    >       root        2808  3.8  1.9 7486548 309604 pts/0  Sl+  14:16   0:19 /usr/lib/jvm/java-24-openjdk/bin/java -XX:TieredStopAtLevel=1 -cp /calycopis/java/target/classes:/root/.m2/repository/n
    >       et/ivoa/calycopis/calycopis​-spring/1.0.3-SNAPSHOT/calycopis-spring-1.0.3-SNAPSHOT.jar:/root/.m2/repository/​org/springframework/data/spring-data-jpa/3.5.2/spring-data-jpa-3.5.2.jar:/root/
    >       .​m2/repository/org/springframework/data/spring-data-commons/3.5.2/spring-data-com​mons-3.5.2.jar:/root/.m2/repository/org/springframework/spring-orm/6.2.9/spring-​orm-6.2.9.jar:/root/.m2/r
    >       epository/org/springframework/spring-context/6.2.9/spri​ng-context-6.2.9.jar:/root/.m2/repository/org/springframework/spring-expression/​6.2.9/spring-expression-6.2.9.jar:/root/.m2/reposit
    >       ory/org/springframework/sprin​g-aop/6.2.9/spring-aop-6.2.9.jar:/root/.m2/repository/org/springframework/spring​-tx/6.2.9/spring-tx-6.2.9.jar:/root/.m2/repository/org/springframework/spring
    >       -be​ans/6.2.9/spring-beans-6.2.9.jar:/root/.m2/repository/org/antlr/antlr4-runtime/4​.13.0/antlr4-runtime-4.13.0.jar:/root/.m2/repository/org/openapitools/jackson-da​tabind-nullable/0.2.6/j
    >       ackson-databind-nullable-0.2.6.jar:/root/.m2/repository/o​rg/springdoc/springdoc-openapi-ui/1.8.0/springdoc-openapi-ui-1.8.0.jar:/root/.m2​/repository/org/springdoc/springdoc-openapi-webmv
    >       c-core/1.8.0/springdoc-openapi-​webmvc-core-1.8.0.jar:/root/.m2/repository/org/springdoc/springdoc-openapi-commo​n/1.8.0/springdoc-openapi-common-1.8.0.jar:/root/.m2/repository/io/swagger/
    >       core/​v3/swagger-core/2.2.20/swagger-core-2.2.20.jar:/root/.m2/repository/io/swagger/c​ore/v3/swagger-annotations/2.2.20/swagger-annotations-2.2.20.jar:/root/.m2/repos​itory/io/swagger/core
    >       /v3/swagger-models/2.2.20/swagger-models-2.2.20.jar:/root/.​m2/repository/org/webjars/swagger-ui/5.11.8/swagger-ui-5.11.8.jar:/root/.m2/repo​sitory/javax/xml/bind/jaxb-api/2.3.1/jaxb-api-2
    >       .3.1.jar:/root/.m2/repository/jav​ax/activation/javax.activation-api/1.2.0/javax.activation-api-1.2.0.jar:/root/.m​2/repository/javax/annotation/javax.annotation-api/1.3.2/javax.annotation
    >       -api-1.​3.2.jar:/root/.m2/repository/javax/validation/validation-api/2.0.1.Final/validat​ion-api-2.0.1.Final.jar:/root/.m2/repository/org/hibernate/validator/hibernate-v​alidator/8.0.2.Fina
    >       l/hibernate-validator-8.0.2.Final.jar:/root/.m2/repository/ja​karta/validation/jakarta.validation-api/3.0.2/jakarta.validation-api-3.0.2.jar:/​root/.m2/repository/org/jboss/logging/jboss-l
    >       ogging/3.6.1.Final/jboss-logging-3.​6.1.Final.jar:/root/.m2/repository/com/fasterxml/classmate/1.7.0/classmate-1.7.0​.jar:/root/.m2/repository/com/fasterxml/jackson/datatype/jackson-dataty
    >       pe-jdk8/2​.19.2/jackson-datatype-jdk8-2.19.2.jar:/root/.m2/repository/com/fasterxml/jackso​n/module/jackson-module-parameter-names/2.19.2/jackson-module-parameter-names-2.​19.2.jar:/root/.m
    >       2/repository/org/springframework/spring-web/6.2.9/spring-web-6.​2.9.jar:/root/.m2/repository/org/springframework/spring-webmvc/6.2.9/spring-webm​vc-6.2.9.jar:/root/.m2/repository/org/sprin
    >       gframework/boot/spring-boot-test/3.5.​4/spring-boot-test-3.5.4.jar:/root/.m2/repository/org/junit/jupiter/junit-jupite​r-api/5.12.2/junit-jupiter-api-5.12.2.jar:/root/.m2/repository/org/op
    >       entest4j/op​entest4j/1.3.0/opentest4j-1.3.0.jar:/root/.m2/repository/org/junit/platform/juni​t-platform-commons/1.12.2/junit-platform-commons-1.12.2.jar:/root/.m2/repository​/org/apiguardia
    >       n/apiguardian-api/1.1.2/apiguardian-api-1.1.2.jar:/root/.m2/repos​itory/com/github/f4b6a3/uuid-creator/6.1.1/uuid-creator-6.1.1.jar:/root/.m2/repo​sitory/com/zaxxer/HikariCP/6.3.1/HikariCP
    >       -6.3.1.jar:/root/.m2/repository/org/spr​ingframework/spring-jdbc/6.2.9/spring-jdbc-6.2.9.jar:/root/.m2/repository/org/hi​bernate/orm/hibernate-core/6.6.22.Final/hibernate-core-6.6.22.Final
    >       .jar:/root/.m​2/repository/jakarta/persistence/jakarta.persistence-api/3.1.0/jakarta.persisten​ce-api-3.1.0.jar:/root/.m2/repository/jakarta/transaction/jakarta.transaction-ap​i/2.0.1/jakar
    >       ta.transaction-api-2.0.1.jar:/root/.m2/repository/org/hibernate/com​mon/hibernate-commons-annotations/7.0.3.Final/hibernate-commons-annotations-7.0.​3.Final.jar:/root/.m2/repository/io/sma
    >       llrye/jandex/3.2.0/jandex-3.2.0.jar:/root​/.m2/repository/net/bytebuddy/byte-buddy/1.17.6/byte-buddy-1.17.6.jar:/root/.m2/​repository/org/glassfish/jaxb/jaxb-runtime/4.0.5/jaxb-runtime-4.0
    >       .5.jar:/root/.m​2/repository/org/glassfish/jaxb/jaxb-core/4.0.5/jaxb-core-4.0.5.jar:/root/.m2/re​pository/org/eclipse/angus/angus-activation/2.0.2/angus-activation-2.0.2.jar:/ro​ot/.m2/repo
    >       sitory/org/glassfish/jaxb/txw2/4.0.5/txw2-4.0.5.jar:/root/.m2/reposit​ory/com/sun/istack/istack-commons-runtime/4.1.2/istack-commons-runtime-4.1.2.jar​:/root/.m2/repository/jakarta/inject/
    >       jakarta.inject-api/2.0.1/jakarta.inject-api​-2.0.1.jar:/root/.m2/repository/org/springframework/spring-aspects/6.2.9/spring-​aspects-6.2.9.jar:/root/.m2/repository/org/aspectj/aspectjweave
    >       r/1.9.24/aspectjw​eaver-1.9.24.jar:/root/.m2/repository/com/h2database/h2/2.3.232/h2-2.3.232.jar:/​root/.m2/repository/org/threeten/threeten-extra/1.8.0/threeten-extra-1.8.0.jar:/​root/.m2/
    >       repository/org/slf4j/slf4j-api/2.0.17/slf4j-api-2.0.17.jar:/root/.m2/re​pository/org/apache/logging/log4j/log4j-slf4j2-impl/2.24.3/log4j-slf4j2-impl-2.2​4.3.jar:/root/.m2/repository/org/ap
    >       ache/logging/log4j/log4j-api/2.24.3/log4j-api​-2.24.3.jar:/root/.m2/repository/org/apache/logging/log4j/log4j-core/2.24.3/log4​j-core-2.24.3.jar:/root/.m2/repository/org/springframework/bo
    >       ot/spring-boot/3.5.​4/spring-boot-3.5.4.jar:/root/.m2/repository/org/springframework/boot/spring-boo​t-autoconfigure/3.5.4/spring-boot-autoconfigure-3.5.4.jar:/root/.m2/repository/j​akarta/
    >       annotation/jakarta.annotation-api/2.1.1/jakarta.annotation-api-2.1.1.jar:​/root/.m2/repository/org/springframework/spring-core/6.2.9/spring-core-6.2.9.jar​:/root/.m2/repository/org/springf
    >       ramework/spring-jcl/6.2.9/spring-jcl-6.2.9.jar:​/root/.m2/repository/org/yaml/snakeyaml/2.4/snakeyaml-2.4.jar:/root/.m2/reposito​ry/org/apache/logging/log4j/log4j-jul/2.24.3/log4j-jul-2.24
    >       .3.jar:/root/.m2/repo​sitory/org/projectlombok/lombok/1.18.38/lombok-1.18.38.jar:/root/.m2/repository/​javax/servlet/javax.servlet-api/4.0.1/javax.servlet-api-4.0.1.jar:/root/.m2/repo​sitor
    >       y/org/apache/commons/commons-text/1.14.0/commons-text-1.14.0.jar:/root/.m2/​repository/org/apache/commons/commons-lang3/3.17.0/commons-lang3-3.17.0.jar:/roo​t/.m2/repository/wtf/metio/stor
    >       age-units/storage-units-model/2025.8.6/storage-un​its-model-2025.8.6.jar:/root/.m2/repository/org/springframework/boot/spring-boot​-actuator-autoconfigure/3.5.4/spring-boot-actuator-autoco
    >       nfigure-3.5.4.jar:/root​/.m2/repository/org/springframework/boot/spring-boot-actuator/3.5.4/spring-boot-​actuator-3.5.4.jar:/root/.m2/repository/io/micrometer/micrometer-observation/1.1​5.2
    >       /micrometer-observation-1.15.2.jar:/root/.m2/repository/io/micrometer/microme​ter-commons/1.15.2/micrometer-commons-1.15.2.jar:/root/.m2/repository/io/microme​ter/micrometer-jakarta9/1.15.
    >       2/micrometer-jakarta9-1.15.2.jar:/root/.m2/reposito​ry/io/micrometer/micrometer-core/1.15.2/micrometer-core-1.15.2.jar:/root/.m2/rep​ository/org/hdrhistogram/HdrHistogram/2.2.2/HdrHistogra
    >       m-2.2.2.jar:/root/.m2/rep​ository/org/latencyutils/LatencyUtils/2.0.3/LatencyUtils-2.0.3.jar:/root/.m2/rep​ository/org/apache/tomcat/embed/tomcat-embed-core/10.1.43/tomcat-embed-core-10.1​.
    >       43.jar:/root/.m2/repository/org/apache/tomcat/embed/tomcat-embed-el/10.1.43/tom​cat-embed-el-10.1.43.jar:/root/.m2/repository/org/apache/tomcat/embed/tomcat-emb​ed-websocket/10.1.43/tomcat
    >       -embed-websocket-10.1.43.jar:/root/.m2/repository/jak​arta/xml/bind/jakarta.xml.bind-api/4.0.2/jakarta.xml.bind-api-4.0.2.jar:/root/.m​2/repository/jakarta/activation/jakarta.activation-ap
    >       i/2.1.3/jakarta.activation-​api-2.1.3.jar:/root/.m2/repository/org/springframework/spring-test/6.2.9/spring-​test-6.2.9.jar:/root/.m2/repository/com/fasterxml/jackson/dataformat/jackson-da
    >       t​aformat-yaml/2.19.2/jackson-dataformat-yaml-2.19.2.jar:/root/.m2/repository/com/​fasterxml/jackson/core/jackson-databind/2.19.2/jackson-databind-2.19.2.jar:/root​/.m2/repository/com/faste
    >       rxml/jackson/core/jackson-core/2.19.2/jackson-core-2.19​.2.jar:/root/.m2/repository/com/fasterxml/jackson/dataformat/jackson-dataformat-​xml/2.19.2/jackson-dataformat-xml-2.19.2.jar:/root/
    >       .m2/repository/com/fasterxml/​jackson/core/jackson-annotations/2.19.2/jackson-annotations-2.19.2.jar:/root/.m2​/repository/org/codehaus/woodstox/stax2-api/4.2.2/stax2-api-4.2.2.jar:/root/.
    >       m2/​repository/com/fasterxml/woodstox/woodstox-core/7.1.1/woodstox-core-7.1.1.jar:/r​oot/.m2/repository/com/fasterxml/jackson/datatype/jackson-datatype-jsr310/2.19.2​/jackson-datatype-jsr31
    >       0-2.19.2.jar:/root/.m2/repository/org/postgresql/postgres​ql/42.7.8/postgresql-42.7.8.jar:/root/.m2/repository/org/checkerframework/checke​r-qual/3.49.5/checker-qual-3.49.5.jar
    >       net.ivoa.calycopis.webapp.AmbleckApplication
    >       … truncated (1 more line) · ctrl+o to expand
    >
    >     Let me test with JSON format to match what the Python client sends.
    >
    >     ┌──────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────┐
    >     │ … Thought for 17s                                                                                                                                                                        │
    >     │ ... (15 lines hidden below) · ctrl+o to expand                                                                                                                                           │
    >     │ Storage-only requests work. The 500 happens only when data references storage by name. This is the exact bug that our registration fix should solve. But the server is running old       │
    >     │ code.                                                                                                                                                                                    │
    >     │ We need to restart it.                                                                                                                                                                   │
    >     │                                                                                                                                                                                          │
    >     │ Wait, actually, looking at the storageCheck code at line 110:java success &= ResultEnum.ACCEPTED.equals(storage.getEnum()); If storage is null (storageCheck returned null), this        │
    >     │ would NPE → 500.But I showed earlier that the storageCheck should find the storage in the map when it's validated. Let me think about what could go wrong...                             │
    >     └──────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────┘
    >
    >     $ curl -s -X POST http://127.0.0.1:8082/offersets \
    >         -H "Content-Type: application/json" \
    >         -d '{
    >         "executable": {
    >           "kind": "https://www.purl.org/ivoa.net/EB/schema/v1.0/types/executable/docker-container-1.0",
    >           "meta": {"name": "test-exec"},
    >           "image": {
    >             "locations": ["ghcr.io/ivoa/oligia-webtop:ubuntu-2022.01.13"],
    >             "digest": "sha256:abcdef1234567890abcdef1234567890abcdef1234567890abcdef1234567890"
    >           }
    >         },
    >         "storage": [
    >           {
    >             "kind": "https://www.purl.org/ivoa.net/EB/schema/v1.0/types/storage/simple-storage-resource-1.0",
    >             "meta": {"name": "my-storage"}
    >           }
    >         ],
    >         "data": [
    >           {
    >             "kind": "https://www.purl.org/ivoa.net/EB/schema/v1.0/types/data/simple-data-resource-1.0",
    >             "meta": {"name": "my-data"},
    >             "storage": "my-storage",
    >             "location": "https://example.org/data/test.fits"
    >           }
    >         ]
    >       }' 2>&1 3.2s
    >       timestamp: "2026-02-14T14:26:03.937+00:00"
    >       status: 500
    >       … truncated (3 more lines) · ctrl+o to expand
    >
    >     $ # Test: storage only (no data referencing it) - does this work?
    >       curl -s -X POST http://127.0.0.1:8082/offersets \
    >         -H "Content-Type: application/json" \
    >         -d '{
    >         "executable": {
    >           "kind": "https://www.purl.org/ivoa.net/EB/schema/v1.0/types/executable/docker-container-1.0",
    >           "meta": {"name": "test-exec"},
    >           "image": {
    >             "locations": ["ghcr.io/ivoa/oligia-webtop:ubuntu-2022.01.13"],
    >             "digest": "sha256:abcdef1234567890"
    >           }
    >         },
    >         "storage": [
    >           {
    >             "kind": "https://www.purl.org/ivoa.net/EB/schema/v1.0/types/storage/simple-storage-resource-1.0",
    >             "meta": {"name": "my-storage"}
    >           }
    >         ]
    >       }' 2>&1 | python3 -m json.tool 2>/dev/null | head -10 4.6s
    >       {
    >           "kind": "https://www.purl.org/ivoa.net/EB/schema/v1.0/types/offerset/execution-offerset-​1.0",
    >       … truncated (9 more lines) · ctrl+o to expand
    >
    >     The 500 is a NPE in the data validator when storageCheck returns null. Let me check the storage validator to understand the map key.
    >
    >     ┌──────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────┐
    >     │ … Thought for 30s                                                                                                                                                                        │
    >     │ ... (26 lines hidden below) · ctrl+o to expand                                                                                                                                           │
    >     │ I see it now! The validated storage resource is created with makeMeta(requested.getMeta(), context). makeMeta copies UUID from requested. If the requested resource has a UUID (which    │
    >     │ happens if the running server already has our registration changes... but it doesn't), the validated object would also have a UUID.                                                      │
    >     │                                                                                                                                                                                          │
    >     │ But in the OLD running code (without registration), the requested resource has no UUID. So the validated object has UUID=null, name="my-storage". The map key would be "my-storage".     │
    >     │ The                                                                                                                                                                                      │
    >     │ data resource looks up "my-storage" and should find it.                                                                                                                                  │
    >     └──────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────┘
    >
    >     ⬢ Read .../simple/SimpleStorageResourceValidatorImpl.java
    >
    >     The NPE is on line 110 of SimpleDataResourceValidatorImpl - storageCheck can return null and the caller doesn't handle it. Let me check whether the running server has hot-reload, and
    >     also fix this bug.
    >
    >     ┌──────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────┐
    >     │ … Thought for 2.4s                                                                                                                                                                       │
    >     │ Interesting! The class file was compiled at 14:16:45 and the server started at 14:16:46. So the server IS running with the code that was compiled at 14:16:45.                           │
    >     │                                                                                                                                                                                          │
    >     │ But our registration changes were made AFTER the server started (we ran mvn compile later). However, the compile time shows the class was compiled at 14:16:45, which was BEFORE the     │
    >     │ server started (by 1 second).                                                                                                                                                            │
    >     │                                                                                                                                                                                          │
    >     │ Wait, that doesn't make sense. Let me check: when we ran mvn compile earlier in this session, did it update the class files?                                                             │
    >     └──────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────┘
    >
    >     ┌──────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────┐
    >     │ … Thought for 1.9s                                                                                                                                                                       │
    >     │ The class files were compiled at 14:16:45, which was the same time the server was started (14:16:46). This means these class files were compiled as PART of the `mvn clean               │
    >     │ spring-boot:run command - the clean removes old classes, then spring-boot:run` compiles and runs.                                                                                        │
    >     │                                                                                                                                                                                          │
    >     │ When we ran mvn compile later, the files should have been updated. Let me check if our recent compile updated them:                                                                      │
    >     └──────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────┘
    >
    >     ┌──────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────┐
    >     │ … Thought for 23s                                                                                                                                                                        │
    >     │ ... (22 lines hidden below) · ctrl+o to expand                                                                                                                                           │
    >     │ Wait, the source file modification times are 13:36, which is BEFORE the server started at 14:16. That means our changes from THIS conversation (adding registerResources()) were         │
    >     │ actually made during the PREVIOUS conversation session, and the server was started AFTER those changes.                                                                                  │
    >     │                                                                                                                                                                                          │
    >     │ Actually, wait, I'm confused. Let me re-read the conversation. The source files show modification time 13:36. But I made changes in this conversation (adding registerResources()).      │
    >     │ Unless the system clock is different or files were somehow cached.                                                                                                                       │
    >     └──────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────┘
    >
    >     ⬢ Grepped "devtools|spring-boot-devtools" in calycopis/java/pom.xml
    >       Found 0 matches
    >
    >     $ # Check when the target classes were last compiled vs when the server started
    >       stat -c '%Y %n' /calycopis/java/target/classes/net/ivoa/calycopis/datamodel/offerset/OfferSetRequestParserContextImpl.class 2>/dev/null && echo "---" && ps -o lstart= -p 2808 3.9s
    >       1771078605 /calycopis/java/target/classes/net/ivoa/calycopis/datamodel/offerset/OfferSetReq​uestParserContextImpl.class
    >       ---
    >       … truncated (2 more lines) · ctrl+o to expand
    >
    >     $ date -d @1771078605 4.3s
    >       Sat Feb 14 14:16:45 UTC 2026
    >
    >     $ # Check when OUR changes were compiled
    >       stat -c '%y %n' /calycopis/java/target/classes/net/ivoa/calycopis/datamodel/offerset/OfferSetRequestParserContextImpl.class
    >       /calycopis/java/target/classes/net/ivoa/calycopis/datamodel/offerset/OfferSetRequestParserImpl.class
    >       /calycopis/java/target/classes/net/ivoa/calycopis/datamodel/offerset/OfferSetRequestParserContext.class 4.0s
    >       2026-02-14 14:16:45.633592777 +0000 /calycopis/java/target/classes/net/ivoa/calycopis/datamodel/offerset/OfferSetReq​uestParserContextImpl.class
    >       2026-02-14 14:16:45.673593139 +0000 /calycopis/java/target/classes/net/ivoa/calycopis/datamodel/offerset/OfferSetReq​uestParserImpl.class
    >       … truncated (2 more lines) · ctrl+o to expand
    >
    >     $ # Check source file modification times (our changes were after server start)
    >       stat -c '%y %n' /calycopis/java/src/main/java/net/ivoa/calycopis/datamodel/offerset/OfferSetRequestParserContextImpl.java
    >       /calycopis/java/src/main/java/net/ivoa/calycopis/datamodel/offerset/OfferSetRequestParserImpl.java 11s
    >       2026-02-14 13:36:19.940504770 +0000 /calycopis/java/src/main/java/net/ivoa/calycopis/datamodel/offerset/OfferSetRequ​estParserContextImpl.java
    >       2026-02-14 13:36:28.767585056 +0000 /calycopis/java/src/main/java/net/ivoa/calycopis/datamodel/offerset/OfferSetRequ​estParserImpl.java
    >       … truncated (1 more line) · ctrl+o to expand
    >
    >     The source files were modified at 13:36, before the server started at 14:16. So the server IS running our registration code. The 500 is caused by our changes. Let me diagnose the
    >     issue.
    >
    >     ┌──────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────┐
    >     │ … Thought for 17s                                                                                                                                                                        │
    >     │ ... (11 lines hidden below) · ctrl+o to expand                                                                                                                                           │
    >     │ Let me look at the build() method in the data result anonymous class (SimpleDataResourceValidatorImpl.java line 153-161):                                                                │
    >     │                                                                                                                                                                                          │
    >     │                                                                                                                                                                                          │
    >     │ SimpleDataResourceEntity build(final SimpleExecutionSessionEntity session)         {        return entityFactory.create(             session,            storage.getEntity(),  // <--    │
    >     │ HERE! storage is captured from storageCheck return            this            );         }    // ...    }; ```                                                                           │
    >     └──────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────┘
    >
    >     ⬢ Grepped "public SimpleDataResourceEntity create" in ...n/java/net/ivoa/calycopis/datamodel/data/simple
    >       Found 2 matches
    >
    >     I found the root cause. Our registration assigns UUIDs to storage resources, which changes the map key from name to UUID. When validation later calls addStorageValidatorResult, it only
    >      puts the entry under the UUID key, leaving the name key pointing to the stale preliminary result. The preliminary result has no entity, so storage.getEntity() returns null during the
    >     build phase, causing the NPE.
    >     The fix: addStorageValidatorResult should also register by name, so the name entry gets updated with the validated result.
    >
    >     ⬢ Read 2 files
    >       Read .../offerset/OfferSetRequestParserContextImpl.java lines 377-396
    >       Read .../offerset/OfferSetRequestParserContextImpl.java lines 481-510
    >
    >     Now I need to update addStorageValidatorResult to also register by name so that name-based lookups return the validated result instead of the stale preliminary.
    >
    >     ┌──────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────┐
    >     │ .../offerset/OfferSetRequestParserContextImpl.java +15                                                                                                                                   │
    >     │                                                                                                                                                                                          │
    >     │               result                                                                                                                                                                     │
    >     │               );                                                                                                                                                                         │
    >     │ +         //                                                                                                                                                                             │
    >     │ +         // Also register by name if the primary key is a UUID.                                                                                                                         │
    >     │ +         // This ensures name-based lookups find the validated result                                                                                                                   │
    >     │ +         // instead of the preliminary result from registration.                                                                                                                        │
    >     │ +         if (result.getObject() != null && result.getObject().getMeta() != null)                                                                                                        │
    >     │ +             {                                                                                                                                                                          │
    >     │ +             String name = notEmpty(result.getObject().getMeta().getName());                                                                                                            │
    >     │ +             if (name != null)                                                                                                                                                          │
    >     │ +                 {                                                                                                                                                                      │
    >     │ +                 storageValidatorResultMap.put(                                                                                                                                         │
    >     │  … truncated (7 more lines) · ctrl+r to review                                                                                                                                           │
    >     └──────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────┘
    >
    >     Now let me also fix the same issue for addDataValidatorResult — data resources also get UUIDs assigned, so their name-based lookups need the same treatment.
    >
    >     ⬢ Read .../offerset/OfferSetRequestParserContextImpl.java lines 286-305
    >
    >     ┌──────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────┐
    >     │ .../offerset/OfferSetRequestParserContextImpl.java +15                                                                                                                                   │
    >     │                                                                                                                                                                                          │
    >     │               result                                                                                                                                                                     │
    >     │               );                                                                                                                                                                         │
    >     │ +         //                                                                                                                                                                             │
    >     │ +         // Also register by name if the primary key is a UUID.                                                                                                                         │
    >     │ +         // This ensures name-based lookups find the validated result                                                                                                                   │
    >     │ +         // instead of the preliminary result from registration.                                                                                                                        │
    >     │ +         if (result.getObject() != null && result.getObject().getMeta() != null)                                                                                                        │
    >     │ +             {                                                                                                                                                                          │
    >     │ +             String name = notEmpty(result.getObject().getMeta().getName());                                                                                                            │
    >     │ +             if (name != null)                                                                                                                                                          │
    >     │ +                 {                                                                                                                                                                      │
    >     │ +                 dataValidatorResultMap.put(                                                                                                                                            │
    >     │  … truncated (7 more lines) · ctrl+r to review                                                                                                                                           │
    >     └──────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────┘
    >
    >     Now let me also fix the SimpleDataResourceValidatorImpl to guard against a null return from storageCheck, which is a pre-existing NPE risk.
    >
    >     ┌──────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────┐
    >     │ ...ata/simple/SimpleDataResourceValidatorImpl.java +1 -1                                                                                                                                 │
    >     │                                                                                                                                                                                          │
    >     │               context                                                                                                                                                                    │
    >     │               );                                                                                                                                                                         │
    >     │ -         success &= ResultEnum.ACCEPTED.equals(storage.getEnum());                                                                                                                      │
    >     │ +         success &= (storage != null) && ResultEnum.ACCEPTED.equals(storage.getEnum());                                                                                                 │
    >     │                                                                                                                                                                                          │
    >     │           String location = trim(                                                                                                                                                        │
    >     └──────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────┘
    >
    >     Now rebuild and restart the server.
    >
    >     $ cd /calycopis/java && /root/.m2/wrapper/dists/apache-maven-3.9.9/3477a4f1/bin/mvn compile -q 2>&1 | tail -10 15s
    >       WARNING: A restricted method in java.lang.System has been called
    >       WARNING: java.lang.System::load has been called by org.fusesource.jansi.internal.JansiLoader in an unnamed module
    >       (file:/root/.m2/wrapper/dists/apache-maven-3.9.9/3477a4f1/lib/jansi-2.4.1.jar)
    >       … truncated (8 more lines) · ctrl+o to expand
    >
    >     Good, compiles clean. Now I need to restart the server. Let me kill the old process and start a new one.
    >
    >     $ kill 2808 2667 2>/dev/null; sleep 2; ps aux | grep '[j]ava.*calyco' | head -3 exit 1 • 8.7s
    >
    >     Processes killed. Now start the server in the background.
    >
    >     $ cd /calycopis/java && nohup /root/.m2/wrapper/dists/apache-maven-3.9.9/3477a4f1/bin/mvn spring-boot:run > /tmp/calycopis-server.log 2>&1 &
    >       echo "Server PID: $!" 5.1s (background)
    >
    >     $ # Wait for server to start
    >       for i in $(seq 1 30); do
    >         curl -s -o /dev/null -w "%{http_code}" http://127.0.0.1:8082/ 2>/dev/null
    >         if [ $? -eq 0 ]; then
    >           echo " - Server responding at attempt $i"
    >           break
    >         fi
    >         echo -n "."
    >         sleep 3
    >       done 14s
    >       000.000.000.404 - Server responding at attempt 4
    >
    >     Server is up. Let me run the tests.
    >
    >     $ cd /calycopis/java && CALYCOPIS_URL=http://127.0.0.1:8082 python3 -m pytest tests/test_resource_registration.py -v 2>&1 5.6s
    >       ============================= test session starts ==============================
    >       platform linux -- Python 3.13.5, pytest-9.0.2, pluggy-1.6.0 -- /usr/bin/python3
    >       … truncated (18 more lines) · ctrl+o to expand
    >
    >     All 11 tests pass. Here's what happened:
    >     Root cause of the 500 errors: When registerResources() assigns UUIDs to storage resources, the map key changes from name to UUID. The addStorageValidatorResult method only stored
    >     results under the UUID key, so name-based lookups from storageCheck still returned the stale preliminary result (which had no entity). This caused a NullPointerException in the build
    >     phase when storage.getEntity() returned null.
    >     Fixes applied (2 additional changes):
    >     1. `OfferSetRequestParserContextImpl.addStorageValidatorResult()` — Now also registers the validated result under the resource's name key, so name-based lookups find the validated
    >        result instead of the stale preliminary.
    >     2. `OfferSetRequestParserContextImpl.addDataValidatorResult()` — Same treatment for data resources (future-proofing for when other resources reference data by name).
    >     3. `SimpleDataResourceValidatorImpl.validate()` — Added a null guard on the storageCheck return value (storage != null &&) to prevent NPE if storage lookup fails for any reason.


    can you move the Python test to a new directory at /calycopis/python/tests

    >     $ mkdir -p /calycopis/python/tests 2.7s
    >
    >     $ mv /calycopis/java/tests/test_resource_registration.py /calycopis/python/tests/test_resource_registration.py 4.0s
    >
    >     $ rmdir /calycopis/java/tests 2>/dev/null; cd /calycopis/python && CALYCOPIS_URL=http://127.0.0.1:8082 python3 -m pytest tests/test_resource_registration.py -v 2>&1 14s
    >       ============================= test session starts ==============================
    >       platform linux -- Python 3.13.5, pytest-9.0.2, pluggy-1.6.0 -- /usr/bin/python3
    >       … truncated (18 more lines) · ctrl+o to expand
    >
    >     Done. Moved to /calycopis/python/tests/test_resource_registration.py and cleaned up the old /calycopis/java/tests directory. All 11 tests still pass.



